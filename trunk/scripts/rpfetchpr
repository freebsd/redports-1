#!/bin/sh

SCRIPT=`basename $0`
TMPPR=`mktemp /tmp/${SCRIPT}.pr.XXXXXX` || exit 1
TMPPATCH=`mktemp /tmp/${SCRIPT}.patch.XXXXXX` || exit 1

fetchpr()
{
   PR=$1

   fetch -qo ${TMPPR} "http://www.freebsd.org/cgi/query-pr.cgi?pr=${PR}&f=raw" || exit 1

   return 0
}

fetchpatch()
{
   PR=$1
   PATCH=$2

   if [ -z "${PATCH}" ]; then
      PATCH=1
   fi

   fetch -qo ${TMPPATCH} "http://www.freebsd.org/cgi/query-pr.cgi?pr=${PR}&getpatch=${PATCH}" || exit 1

   return 0
}

detectpatchtype()
{
   if [ "`head -1 ${TMPPATCH}`" = "# This is a shell archive.  Save it in a file, remove anything before" ]; then
      echo "SH"
   elif egrep "^\-\-\- " ${TMPPATCH} >/dev/null && egrep "^\+\+\+ " ${TMPPATCH} >/dev/null ; then
      echo "PATCH"
   else
      echo "UNKNOWN"
   fi
}

detectport()
{
   # Remove synopsis, strip tags in [...], trim, take first word until ":" or space
   PORT=`grep -i ">Synopsis:" ${TMPPR} | cut -b11- | sed 's/\[.*\]//' | sed 's/^[[:space:]]*\(.*\)[[:space:]]*$/\1/' | sed 's/\([^[:space:]\:]*\).*/\1/'`

   if [ -z "${PORT}" -o -z "${PORT%${PORT##*/}}" -o ! -d "/usr/ports/${PORT%${PORT##*/}}" ]; then
      return 1
   fi

   echo ${PORT}
   return 0
}

fixpaths()
{
   PORT=$1
   FILE=`egrep "^\+\+\+ " ${TMPPATCH} | cut -d' ' -f2 | cut -s -f1 | head -1`

   # /home/pcvs/ports/devel/py-thrift/Makefile
   if echo "${FILE}" | grep "${PORT}" - >/dev/null ; then
      SUBPATH=`echo "${FILE}" | sed "s%\(.*\)${PORT}\(.*\)%\1%"`
      replacepath "${SUBPATH}" "" ${TMPPATCH}
      return 0
   fi

   # Makefile
   if [ "${FILE}" = "Makefile" ]; then
      replacepath "" "${PORT}/" ${TMPPATCH}
      return 0
   fi

   # xfce4-wm/Makefile
   if [ "${FILE##*/}" = "Makefile" ]; then
      replacepath `dirname "${FILE}"` "${PORT}" ${TMPPATCH}
      return 0
   fi

   echo "Could not fix path for ${FILE}"
   return 1
}

replacepath()
{
   SEARCH=$1
   REPLACE=$2
   FILE=$3

   sed -i.bak "s%^\+\+\+ ${SEARCH}%\+\+\+ ${REPLACE}%" ${FILE}
}

PR=${1}
PATCH=${2}
PORT=${3}

fetchpr ${PR} || exit 1
fetchpatch ${PR} ${PATCH} || exit 1

if [ -z "${PORT}" ]; then
   PORT=`detectport`
   if [ $? -ne 0 ]; then
      echo "Portname not detected"
      exit 1
   fi
fi

TYPE=`detectpatchtype`

if [ "${TYPE}" = "PATCH" ]; then
   fixpaths "${PORT}" || exit 1
   cp -p ${TMPPATCH} ${PR}.diff
elif [ "${TYPE}" = "SH" ]; then
   cp -p ${TMPPATCH} ${PR}.sh
fi

rm -f ${TMPPR} ${TMPPATCH} ${TMPPATCH}.bak

echo ${PORT}
return 0

